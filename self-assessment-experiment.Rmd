---
title: "Self-assessment experiment data analysis"
author: "Carlos Granell"
date: "15/04/2020 (updated `r format(Sys.time(), '%d %B, %Y')`)"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE, eval=TRUE}
knitr::opts_chunk$set(echo=FALSE)
```


This document analyses the responses of a [pre-questionnaire](https://forms.gle/BTmPc5ExhEJNkUtFA) and (soon) a post-questionnaire as part of the experiment **Reproducibility of GIScience MSc Theses - Self-assessment experiment** - see [OSF project](https://osf.io/j97zp/)


## Reproduce paper

To create the PDF of the computational notebook you can run the following commands in a new R session.
If you have problems rendering the PDF you can execute each chunk independently in [RStudio](https://rstudio.com/products/rstudio/).

```{r render_with_rmarkdown, eval=FALSE}
require("knitr")
require("rmarkdown")
rmarkdown::render("self-assessment-experiment.Rmd", output_format = "pdf_document")
```

## Software dependencies and code

This document does not install the required R packages by default.
You can run the script `install.R` to install all required dependencies on a new R installation, or use `install.packages(..)` to install missing R packages.

```{r install_r, eval=FALSE}
source("install.R")
```

Required libraries and runtime environment description are as follows.

```{r load_libraries, echo=TRUE, message=FALSE, warning=FALSE}
library("tidyverse")
library("forcats")
library("kableExtra")
library("here")
library("googlesheets4")
library("likert")
```


```{r set_seed}
# just in case
set.seed(nchar("Self-assessment experiment"))
```


## Download raw survey data

Students who did not belong to the self-assessment experiment are filtered, and fields that refer to personal information (email, thesis handle, and url to pdf file) are removed and therefore, are not used in the analysis.


```{r pretestdata_file}
pretest_file <- here::here("data-raw", "pre_test.csv")

dissertation_file <- here::here("data-raw", "theses_2020_geotech.csv")

```

```{r pretestdata_download}
pretest_sheet <- googlesheets4::read_sheet("https://drive.google.com/open?id=1YhcOeTg04AXh7mbDzjqefuuHUG91sr98e15rl92M2Zk")

geotech_theses <- googlesheets4::read_sheet("https://drive.google.com/open?id=1a51epnQviXJhLLuKu5Gn6m_hqv4NnMzNLNlt_gQcqCE")
```


```{r pretestdata_filtered}
pretest_sheet_filtered <- 
  pretest_sheet %>%
  filter(`Please choose your MASTER programme` %in% c("MSc in Geospatial Technologies (UJI, NOVA IMS, IFGI-WWU)",
                                                      "MSc Geomatics Master (TU Delft)")) %>%
  mutate(id = row_number()) %>%
  rename(email = `Please introduce your university E-MAIL address`) %>%
  left_join(geotech_theses, by="email") %>%
  select(-email, -handle, -url_pdf)

n_answered_no <- nrow(anti_join(geotech_theses, pretest_sheet_filtered))
n_answered_yes <- nrow(geotech_theses) - n_answered_no 

write.csv(pretest_sheet_filtered, file = pretest_file)

```

`r format((nrow(geotech_theses) / 24)*100, 0)`% (`r nrow(geotech_theses)`/24) of students (EM Master Geotech) provided a self-assessment statement:

- `r n_answered_yes` added the self-assessment statement (to the thesis manuscript) and answered the pre-questionnaire. Self-assessment statements are added to the analysis.

- `r n_answered_no` added the self-assessment statement but _did not_ answered the pre-questionnaire. These two cases are omitted from the analysis.


## Pre-test assessment 

The following plots are based on the file `r pretest_file`, filtered by students from _MSc in Geospatial Technologies (UJI, NOVA IMS, IFGI-WWU)_ and _MSc Geomatics (TU Delft)_.

```{r load_evaldata, warning=FALSE}

category_levels <- c("0", "1", "2", "3")

pretest_data <- read_csv(pretest_file, col_names = TRUE, trim_ws=TRUE, 
                       col_types = cols(
                         .default = col_character(),
                         input_data = col_factor(levels = category_levels),
                         preprocessing = col_factor(levels = category_levels),
                         methods = col_factor(levels = category_levels),
                         computational_environment = col_factor(levels = category_levels),
                         results = col_factor(levels = category_levels)),
                       na = "NA")

names(pretest_data) <- names(pretest_data) %>% 
  sub(pattern = "Imagine that you are going to explain the following terms to somebody else. How well do you KNOW them\\? \\[*", replacement = "") %>% 
  sub(pattern = "\\]", replacement = "")

# Terms organised according to the five "schools of thoughts"
# cher & Friesike (2014). Open Science: One Term, Five Schools of Thought. https://doi.org/10.1007/978-3-319-00026-8_2
terms <- tibble(
  school = c(rep("democratic", 6), rep("pragmatic", 5), rep("infrastruture", 4), rep("public", 3)),
  column = names(pretest_data)[7:24]
)

```

```{r pretestdata_to_likert}

likert_levels <- c("I have never heard of this term",
                   "I have heard this term before, but I have a vague idea of what it is",
                   "I am familiar with the term but it would be difficult to explain it",
                   "I can explain this term in my own words but I do not use it myself",
                   "I can easily define what exactly this term means and I use it myself")

likert_factor <- function(x) {factor(x, levels = likert_levels)}

pretest_data <- 
  pretest_data %>%
  # drop_na() %>%
  mutate_at(pull(terms, column), likert_factor) %>%
  select(-X1)

```



### MSc in Geospatial Technologies  (UJI, NOVA IMS, IFGI-WWU)

```{r pretest_geotec_stats}

pretest_geotech <- 
  pretest_data %>%
  filter(`Please choose your MASTER programme` == c("MSc in Geospatial Technologies (UJI, NOVA IMS, IFGI-WWU)"))

n_participants <- nrow(pretest_geotech)
n_trained <- nrow(pretest_geotech %>% filter(`Have you ever been TRAINED on reproducible research practices?` == "YES"))
```

`r n_participants` students answered the pre-questionnaire. 

#### Section 1: previous knowledge/experience on reproducible research

`r n_trained` students have been previously trained on reproducible research practices.

```{r pretest_geotech_terms}
results <- 
  pretest_geotech %>%
  select(pull(terms, column)) %>%
  as.data.frame() %>%
  likert()

summaries <- 
  summary(results) %>%
  inner_join(terms, by=c("Item" ="column")) %>%
  select(school, Item, low, neutral, high, mean, sd)
```

```{r pretest_geotech_terms_table}
kable(summaries,
      digits = 2,
      row.names = FALSE,
      col.names = c("School of thought", "Term", "low (%)", "neutral (%)", "high (%)", "mean", "sd"),
      format = "html",
      booktabs = TRUE,
      caption = paste0("Percentage of answers in the disagree (low), agree (high) or neutral categories.\n",
                       "Mean response with standard deviation using numeric values 1 to 5 for 'Strongly disagree' to 'Strongly agree'.\n",
                       "Terms are ordered by 'high' category.")) %>%
      kable_styling(full_width = TRUE)
```


```{r eval=FALSE}
democratic_cols <- filter(terms, school =="democratic") %>% select(column) %>% pull()

democratic_results <- 
  pretest_geotech %>%
  select(democratic_cols) %>%
  as.data.frame() %>%
  likert()

```


```{r fig_likert_terms, fig.width=15, fig.height=10, dpi=300}
plot(results, type="bar", legend = "", legend.position = "bottom",
     low.color = "goldenrod2", high.color="indianred4") +
  ggtitle(paste0("How well do you KNOW these terms? (N=", n_participants, ")")) + 
  theme_bw()


```



```{r pretest_geotech_perception}
yesno_levels <- c("YES", "NO")
percepcion_levels <- c("1", "2", "3", "4", "5")

pretest_geotech <- 
  pretest_geotech %>%
  mutate(`Have you ever experienced DIFFICULTIES IN REUSING somebody else’s code / data?` = factor(`Have you ever experienced DIFFICULTIES IN REUSING somebody else’s code / data?`, levels = yesno_levels),
         `Have you ever had to REUSE YOUR OWN past code/data?` = factor(`Have you ever had to REUSE YOUR OWN past code/data?`, levels = yesno_levels),
         `Please rate the perceived IMPORTANCE of doing your research in a reproducible way` = factor(`Please rate the perceived IMPORTANCE of doing your research in a reproducible way`, levels = percepcion_levels))
```


```{r pretest_geotech_perception_table}
options(knitr.kable.NA = '-')
kable(pretest_geotech %>% 
      select(`Have you ever experienced DIFFICULTIES IN REUSING somebody else’s code / data?`,
             `Have you ever had to REUSE YOUR OWN past code/data?`,
             `If you answered YES in either of the last two questions, please explain which were the MAIN DIFFICULTIES you experienced. If NO, skip question`,
             `Do you know where to look for HELP and extra information to make your research reproducible?`,
             `Please rate the perceived IMPORTANCE of doing your research in a reproducible way`,
             `According to you, why is it IMPORTANT (or not) to do your research in a reproducible way?`),
      booktabs = TRUE,
      caption = paste0("Previous experience in reproducibility, main difficulties and perceived importance, \n",
                        "using numeric values 1 to 5 for 'No important at all' to 'Really important'.")) %>%
  kable_styling(full_width = TRUE, latex_options = "scale_down")
  
```


#### Section 2: Current working practices

```{r pretest_geotech_working_practices}
questions_practices <- tibble(
  analysis = c("What tools do you plan to use to ANALYSE data?"),
  visualisation =c("What tools do you plan to use to VISUALISE/PLOT data?"),
  writing = c("What tools do you plan to WRITE UP your master thesis or conference/journal article?"),
  workflow = c("What is your (expected) process of GETTING the summary data, statistical results, figures, maps and tables IN your master thesis document (or conference/journal article)?"))



practices <- function(data, group) {
  data %>%
    separate_rows(practice, sep = "\\),") %>%   # But ")" is also gone..
    mutate(practice = stringr::str_trim(practice),
           practice = if_else(str_sub(practice, -1) == ")", practice, paste0(practice, ")"))) %>%
    add_column(practice_group=group)
}


working_practices <- data.frame()
for (q in 1:length(questions_practices)) {
  res <- practices(select(pretest_geotech, practice = questions_practices[[q]]), names(questions_practices)[q])
  working_practices <- bind_rows(working_practices, res)
}



kable(t(questions_practices),
      col.names = c("Practice group - Survey question"), 
      format = "html",
      booktabs = TRUE,
      caption = paste0("Note that responses to 'working practices' were multi-choice (N=", n_participants, ").")) %>%
  kable_styling(full_width = TRUE)
```

```{r Fig_practices,fig.width=15, dpi=300}

ggplot(working_practices, aes(x=forcats::fct_infreq(practice))) +
    geom_bar(aes(fill=factor(practice_group))) +
    coord_flip() +
    labs(title = "What tools do you plan to use to...?") +
    facet_grid(rows = vars(practice_group), scales = "free_y") +
    guides(fill= FALSE) +
    theme_bw()

```



#### Section 3: Previous education background / work experience /...


```{r pretest_geotech_backgroubd_table}
# options(knitr.kable.NA = '-')
kable(pretest_geotech %>% 
      select(`What BACHELOR DEGREE (or equivalent) did you have when applying for the master programme?`,
             `How many years of PROFESSIONAL EXPERIENCE did you have when applying for the master programme?`,
             `How many years of PROFESSIONAL EXPERIENCE did you have when applying for the master programme?`,
             `In which context are you DEVELOPING your master thesis?`,
             `Please select which sentence better describes the PLAN you have after the completion of your Master thesis`),
      booktabs = TRUE,
      caption = "Previous education backgroudn and work experience, adn prospecet for future.") %>%
  kable_styling(full_width = TRUE)
  
```

#### Results of self-assessment reproducibility

```{r fig_selfasses, fig.width=10}
# match the colours to time series plot below
categoryColumns <- c("input_data", 
                     "preprocessing",
                     "methods",
                     "computational_environment",
                     "results")
colours <- RColorBrewer::brewer.pal(length(categoryColumns), "Set1")

level_names <- c("0", "1", "2", "3", "NA")
criteriaBarplot = function(data, main, colour) {
  barplot(table(data, useNA = "always"), 
          main = main,
          xlab = "Level", 
          ylim = c(0,25),
          names.arg = level_names,col = colours[colour])
}

par(mfrow = c(1,length(categoryColumns)))

criteriaBarplot(pretest_geotech$input_data,
                main = "A: Input data", colour = 1)
criteriaBarplot(pretest_geotech$preprocessing,
                main = "B: Preprocessing", colour = 2)
criteriaBarplot(pretest_geotech$methods,
                main = "C: Methods/Analysis/\nProcessing", colour = 3)
criteriaBarplot(pretest_geotech$computational_environment,
                main = "D: Computational\nEnvironment", colour = 4)
criteriaBarplot(pretest_geotech$results,
                main = "E: Results", colour = 5)
```


### MSc Geomatics (TU Delft) 

**TODO**
